<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç¯‰ç¶“ç‡Ÿå”æœƒæ…ˆå–„è³­ç‹Black Jack å¤§è³½</title>
    <!-- è¼‰å…¥ Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Noto Sans å­—é«” (ç”¨æ–¼ä¸­æ–‡å’Œè‹±æ–‡) --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #f59e0b; /* Amber 500 */
            --secondary-color: #dc2626; /* Red 600 */
            --gold-start: #ffeb3b; /* Light Gold */
            --gold-end: #f59e0b;   /* Darker Gold (Amber) */
            --card-back-red: #ff8888; /* Light Red for card back */
        }
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            /* è¨­ç½®èƒŒæ™¯åœ–ç‰‡ */
            background-image: url('https://i.imgur.com/ZzKd8Lt.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }
        #gameCanvas {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.25);
            border: 4px solid var(--primary-color);
            background-color: rgba(30, 64, 46, 0.9); /* Dark Green Table */
        }
        
        /* --- æŒ‰éˆ•æ¨£å¼å‡ç´šï¼šä¿ç•™äº’å‹•æ•ˆæœï¼Œç§»é™¤èƒŒæ™¯ä»¥ä¾¿åœ–ç‰‡é¡¯ç¤º --- */
        .control-btn {
            /* ä¿æŒéŸ¿æ‡‰å¼ Paddingï¼Œä½†è®“åœ–ç‰‡å¡«æ»¿ */
            @apply px-1 py-1 rounded-xl font-bold transition duration-300 ease-in-out shadow-lg transform hover:scale-105 border-0;
            /* è‡ªè¨‚é™°å½± */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            /* å°‡èƒŒæ™¯è¨­ç‚ºé€æ˜æˆ–ç™½è‰²ï¼Œè®“åœ–ç‰‡é¡¯ç¤º */
            background-color: transparent !important; 
            color: transparent !important; /* éš±è— fallback æ–‡å­— */
            line-height: 0; /* ç§»é™¤è¡Œé«˜ï¼Œè®“åœ–ç‰‡æ›´å¥½åœ°å±…ä¸­ */
        }
        /* çµ±è¨ˆé‡ç½®æŒ‰éˆ•ä»ä½¿ç”¨åŸå§‹çš„é‡‘è‰²æ¼¸å±¤ */
        #resetStatsBtn {
            background: linear-gradient(180deg, var(--gold-start) 0%, var(--gold-end) 100%) !important;
            color: #1a202c !important;
            line-height: normal; /* æ¢å¾©è¡Œé«˜ */
            @apply px-3 py-1 text-xs md:text-sm;
        }
        /* æŒ‰éˆ•å…§çš„åœ–ç‰‡æ¨£å¼ */
        .button-img {
            /* ç¢ºä¿åœ–ç‰‡å¡«æ»¿æŒ‰éˆ•ä¸”ä¸è®Šå½¢ */
            @apply w-full h-full object-contain p-0;
        }
    </style>
</head>
<body class="p-1 md:p-6 flex flex-col items-center">

    <!-- æ¨™é¡Œèˆ‡ Logo å€å¡Š: ç§»é™¤ max-w-lg é™åˆ¶ï¼Œä½¿ç”¨ w-full --><div class="w-full mx-auto mb-3 p-3 rounded-xl bg-gray-900/80 shadow-2xl flex items-center space-x-4">
        <img id="logoImg" src="https://i.imgur.com/sDO3tAh.png" alt="Logo" class="w-16 h-auto">
        <div class="text-left">
            <h1 class="text-lg md:text-xl font-black text-white leading-snug">å»ºç¯‰ç¶“ç‡Ÿå”æœƒæ…ˆå–„è³­ç‹<br>Black Jack å¤§è³½</h1>
        </div>
    </div>

    <!-- éŠæˆ²çµ±è¨ˆå€: ç§»é™¤ max-w-lg é™åˆ¶ï¼Œä½¿ç”¨ w-full --><div class="w-full mx-auto mb-3 p-3 bg-gray-800/90 rounded-xl shadow-xl flex justify-around text-white text-sm md:text-base">
        <div class="text-center">
            <div class="font-bold text-gray-400">å‹å ´ (Wins)</div>
            <div id="statWins" class="text-green-400 text-xl font-mono">0</div>
        </div>
        <div class="text-center">
            <div class="font-bold text-gray-400">æ•—å ´ (Losses)</div>
            <div id="statLosses" class="text-red-400 text-xl font-mono">0</div>
        </div>
        <div class="text-center">
            <div class="font-bold text-gray-400">å‹ç‡ (Rate)</div>
            <div id="statRate" class="text-yellow-400 text-xl font-mono">0.00%</div>
        </div>
        <button id="resetStatsBtn" class="control-btn bg-blue-500 text-white px-3 py-1 self-center text-xs md:text-sm">é‡ç½®çµ±è¨ˆ</button>
    </div>

    <!-- Canvas éŠæˆ²å€: ç§»é™¤ max-w-lg é™åˆ¶ï¼Œä¸¦å°‡é•·å¯¬æ¯”èª¿æ•´ç‚º 5/4 (æ›´æ¥è¿‘æ­£æ–¹å½¢ï¼Œé©åˆæ‰‹æ©Ÿ) --><div class="w-full aspect-[5/4] mx-auto relative rounded-xl overflow-hidden">
        <canvas id="gameCanvas" class="w-full h-full"></canvas>
    </div>

    <!-- éŠæˆ²æ§åˆ¶æŒ‰éˆ•å€: ç§»é™¤ max-w-lg é™åˆ¶ï¼Œä½¿ç”¨ w-full --><div id="controls" class="w-full mx-auto mt-3 mb-3 flex justify-center space-x-4">
        <!-- åˆå§‹æŒ‰éˆ•å°‡åœ¨ JS ä¸­è¨­å®šç‚ºåœ–ç‰‡ --><button id="hitBtn" class="control-btn w-1/3">è¦ç‰Œ (Hit)</button>
        <button id="standBtn" class="control-btn w-1/3">åœç‰Œ (Stand)</button>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statWins = document.getElementById('statWins');
        const statLosses = document.getElementById('statLosses');
        const statRate = document.getElementById('statRate');
        const controlsDiv = document.getElementById('controls');
        
        // éŠæˆ²ç‹€æ…‹
        let deck = [];
        let playerHand = [];
        let dealerHand = [];
        let gameActive = false;
        let gameStatus = 'initial'; // 'initial', 'playerTurn', 'dealerTurn', 'end'
        
        // çµ±è¨ˆæ•¸æ“š
        let stats = { wins: 0, losses: 0 };

        // å¡ç‰Œåœ–ç‰‡ URLs (ä½¿ç”¨ placeholder ä½œç‚ºé€šç”¨å¡ç‰‡å’ŒèƒŒé¢)
        const customCardImages = {
            J: 'https://i.imgur.com/v16ILID.png',
            Q: 'https://i.imgur.com/5d46u7D.png',
            K: 'https://i.imgur.com/MolqeHf.png',
            BACK: 'https://placehold.co/100x150/606060/FFFFFF?text=Card+Back', // ç°è‰²å¡èƒŒ
            WELCOME: 'https://i.imgur.com/Y9znMk1.png', // æ­¡è¿åœ–ç‰‡
            
            // æ–°å¢çš„æŒ‰éˆ•åœ–ç‰‡
            HIT_BTN: 'https://i.imgur.com/wBUAsyk.png', 
            STAND_BTN: 'https://i.imgur.com/778ZjRH.png', 
            NEW_BTN: 'https://i.imgur.com/yudolIL.png' 
        };
        
        // åœ–ç‰‡è³‡æºè¼‰å…¥
        const images = {};
        const cardValues = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const cardSuits = ['â™¥', 'â™¦', 'â™ ', 'â™£'];
        
        // totalImages ç¾åœ¨åŒ…å« J, Q, K, WELCOME, HIT_BTN, STAND_BTN, NEW_BTN (å…± 7 å¼µ)
        let imagesLoaded = 0;
        const totalImages = 7; 
        
        // --- 1. åœ–ç‰‡è¼‰å…¥å‡½æ•¸ ---
        function loadImages() {
            // è¼‰å…¥æ‰€æœ‰åœ–ç‰‡ï¼ŒåŒ…æ‹¬æ’²å…‹ç‰Œåœ–ç‰‡å’ŒæŒ‰éˆ•åœ–ç‰‡
            const keys = ['J', 'Q', 'K', 'WELCOME', 'HIT_BTN', 'STAND_BTN', 'NEW_BTN']; 
            keys.forEach(key => {
                images[key] = new Image();
                images[key].onload = () => {
                    imagesLoaded++;
                    if (imagesLoaded === totalImages) {
                        console.log('æ‰€æœ‰åœ–ç‰‡è¼‰å…¥å®Œæˆã€‚');
                        loadStats();
                        resizeCanvas();
                        drawGame();
                    }
                };
                images[key].onerror = () => {
                    console.error(`åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${key} (${customCardImages[key]})`);
                    images[key] = null; // å¤±æ•—æ™‚è¨­å®šç‚º nullï¼Œä»¥ä¾¿å›é€€
                    imagesLoaded++;
                    if (imagesLoaded === totalImages) {
                        loadStats();
                        resizeCanvas();
                        drawGame();
                    }
                };
                images[key].src = customCardImages[key];
            });
        }
        
        // --- 2. çµ±è¨ˆæ•¸æ“š (localStorage) ç®¡ç† ---
        function loadStats() {
            try {
                const storedStats = localStorage.getItem('blackjackStats');
                if (storedStats) {
                    stats = JSON.parse(storedStats);
                }
            } catch (e) {
                console.error("ç„¡æ³•å¾ localStorage è®€å–çµ±è¨ˆæ•¸æ“š", e);
                stats = { wins: 0, losses: 0 };
            }
            updateStatsDisplay();
        }

        function saveStats() {
            try {
                localStorage.setItem('blackjackStats', JSON.stringify(stats));
            } catch (e) {
                console.error("ç„¡æ³•å„²å­˜çµ±è¨ˆæ•¸æ“šåˆ° localStorage", e);
            }
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            statWins.textContent = stats.wins;
            statLosses.textContent = stats.losses;
            const totalGames = stats.wins + stats.losses;
            const rate = totalGames > 0 ? (stats.wins / totalGames) * 100 : 0;
            statRate.textContent = `${rate.toFixed(2)}%`;
        }
        
        function resetStats() {
            stats = { wins: 0, losses: 0 };
            saveStats();
            // å¦‚æœéŠæˆ²åœ¨çµæŸç‹€æ…‹ï¼Œé‡æ–°ç¹ªè£½ä»¥æ›´æ–°çµ±è¨ˆæ•¸å­—
            if (gameStatus === 'end' || gameStatus === 'initial') {
                drawGame();
            }
        }

        // --- 3. æ ¸å¿ƒéŠæˆ²é‚è¼¯ (ä¸è®Š) ---
        
        // ç”¢ç”Ÿä¸€å‰¯æ–°ç‰Œçµ„ä¸¦æ´—ç‰Œ (Fisher-Yates æ¼”ç®—æ³•)
        function createAndShuffleDeck() {
            deck = [];
            for (let suit of cardSuits) {
                for (let value of cardValues) {
                    deck.push({ value, suit });
                }
            }
            // æ´—ç‰Œ
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function dealCard(hand) {
            if (deck.length > 0) {
                hand.push(deck.pop());
            }
        }

        /**
         * è¨ˆç®—æ‰‹ç‰Œç¸½åˆ† (è‡ªå‹•è™•ç† A é»æ•¸ 1/11)
         */
        function calculateScore(hand, isDealerHidden = false) {
            let score = 0;
            let aceCount = 0;
            const cardsToCount = isDealerHidden ? hand.slice(1) : hand;

            for (let card of cardsToCount) {
                if (card.value === 'A') {
                    aceCount++;
                    score += 11;
                } else if (['K', 'Q', 'J'].includes(card.value)) {
                    score += 10;
                } else {
                    score += parseInt(card.value);
                }
            }

            // èª¿æ•´ A çš„é»æ•¸ (11 -> 1) ç›´åˆ°ç¸½åˆ†ä¸é«˜æ–¼ 21
            while (score > 21 && aceCount > 0) {
                score -= 10; // 11 è®Šæˆ 1
                aceCount--;
            }

            return score;
        }

        // --- 4. éŠæˆ²æµç¨‹æ§åˆ¶ ---
        
        /**
         * è¼”åŠ©å‡½æ•¸: ç”Ÿæˆå¸¶åœ–ç‰‡çš„æŒ‰éˆ• HTML å…§å®¹
         */
        function getButtonHtml(key, fallbackText) {
            const img = images[key];
            if (img && img.complete) {
                // ä½¿ç”¨åœ–ç‰‡ä½œç‚ºæŒ‰éˆ•å…§å®¹
                return `<img src="${img.src}" alt="${fallbackText}" class="button-img">`;
            }
            // åœ–ç‰‡æœªè¼‰å…¥æˆ–å¤±æ•—æ™‚ï¼Œå›é€€åˆ°æ–‡å­—
            return fallbackText;
        }

        function startGame() {
            if (gameActive) return;

            deck = createAndShuffleDeck();
            playerHand = [];
            dealerHand = [];
            gameStatus = 'playerTurn';
            gameActive = true;
            
            // ä½¿ç”¨åœ–ç‰‡æŒ‰éˆ• (ä¿ç•™ control-btn class çš„äº’å‹•æ•ˆæœ)
            controlsDiv.innerHTML = `
                <button id="hitBtn" class="control-btn w-1/3">${getButtonHtml('HIT_BTN', 'è¦ç‰Œ (Hit)')}</button>
                <button id="standBtn" class="control-btn w-1/3">${getButtonHtml('STAND_BTN', 'åœç‰Œ (Stand)')}</button>
            `;
            document.getElementById('hitBtn').onclick = hit;
            document.getElementById('standBtn').onclick = stand;

            // ç™¼åˆå§‹å…©å¼µç‰Œ
            dealCard(playerHand);
            dealCard(dealerHand);
            dealCard(playerHand);
            dealCard(dealerHand);

            drawGame();
            checkBlackjack();
        }
        
        function hit() {
            if (gameStatus !== 'playerTurn') return;

            dealCard(playerHand);
            drawGame();
            
            const score = calculateScore(playerHand);
            if (score > 21) {
                endGame('bust');
            } else if (score === 21) {
                // ç©å®¶æ‹¿åˆ° 21 é»ï¼Œè‡ªå‹•åœç‰Œï¼Œæ›èŠå®¶å›åˆ
                stand();
            }
        }
        
        function stand() {
            if (gameStatus !== 'playerTurn') return;

            gameStatus = 'dealerTurn';
            // ç«‹å³é¡¯ç¤ºèŠå®¶åº•ç‰Œ
            drawGame(); 
            
            // èŠå®¶å›åˆå»¶é²è™•ç†
            setTimeout(dealerPlay, 1000);
        }

        function dealerPlay() {
            let dealerScore = calculateScore(dealerHand);
            
            // èŠå®¶è¦å‰‡: 16 é»æˆ–ä»¥ä¸‹å¿…é ˆè¦ç‰Œï¼›17 é»æˆ–ä»¥ä¸Šå¿…é ˆåœç‰Œ
            if (dealerScore < 17) {
                dealCard(dealerHand);
                drawGame();
                dealerScore = calculateScore(dealerHand);
                
                if (dealerScore > 21) {
                    endGame('dealerBust');
                } else {
                    // ç¹¼çºŒä¸‹ä¸€æ¬¡æª¢æŸ¥
                    setTimeout(dealerPlay, 1000); 
                }
            } else {
                // èŠå®¶åœç‰Œ (>= 17)
                endGame('finalCheck');
            }
        }
        
        function checkBlackjack() {
            const pScore = calculateScore(playerHand);
            const dScore = calculateScore(dealerHand);

            if (pScore === 21 && dScore === 21) {
                endGame('push');
            } else if (pScore === 21) {
                endGame('playerBlackjack');
            } else if (dScore === 21) {
                endGame('dealerBlackjack');
            }
        }

        function endGame(reason) {
            gameActive = false;
            gameStatus = 'end';
            
            let message = '';
            let win = false;
            const pScore = calculateScore(playerHand);
            const dScore = calculateScore(dealerHand);

            switch (reason) {
                case 'bust': // ç©å®¶çˆ†ç‰Œ
                    message = `ğŸ’¥ ç©å®¶çˆ†ç‰Œ! (${pScore}) èŠå®¶ç²å‹!`;
                    stats.losses++;
                    break;
                case 'dealerBust': // èŠå®¶çˆ†ç‰Œ
                    message = `èŠå®¶çˆ†ç‰Œ! (${dScore}) ğŸ‰ ç©å®¶ç²å‹!`;
                    stats.wins++;
                    win = true;
                    break;
                case 'playerBlackjack': // ç©å®¶ Blackjack
                    message = `â™ ï¸â™¥ï¸ ç©å®¶ Blackjack! ç©å®¶ç²å‹!`;
                    stats.wins++;
                    win = true;
                    break;
                case 'dealerBlackjack': // èŠå®¶ Blackjack
                    message = `â™¦ï¸â™£ï¸ èŠå®¶ Blackjack! èŠå®¶ç²å‹!`;
                    stats.losses++;
                    break;
                case 'push': // å¹³æ‰‹ (Blackjack æˆ–é»æ•¸ç›¸åŒ)
                    message = `ğŸ¤ å¹³æ‰‹ (Push)! ä¸è¨ˆå‹æ•—ã€‚`;
                    break;
                case 'finalCheck': // èŠå®¶åœç‰Œï¼Œé€²è¡Œæœ€çµ‚é»æ•¸æ¯”è¼ƒ
                    if (pScore > dScore) {
                        message = `ç©å®¶ ${pScore} é» > èŠå®¶ ${dScore} é»! ğŸ‰ ç©å®¶ç²å‹!`;
                        stats.wins++;
                        win = true;
                    } else if (dScore > pScore) {
                        message = `èŠå®¶ ${dScore} é» > ç©å®¶ ${pScore} é»! èŠå®¶ç²å‹!`;
                        stats.losses++;
                    } else {
                        message = `ğŸ¤ å¹³æ‰‹ (Push)! ${pScore} é»ã€‚ä¸è¨ˆå‹æ•—ã€‚`;
                    }
                    break;
                default:
                    message = 'éŠæˆ²çµæŸã€‚';
            }
            
            saveStats();
            drawGame(message); // å¸¶ä¸Šæœ€çµ‚è¨Šæ¯ç¹ªè£½ä¸€æ¬¡
            
            // å‹•æ…‹é¡¯ç¤ºã€Œå†ä¾†ä¸€å±€ã€åœ–ç‰‡æŒ‰éˆ• (å–ä»£æ§åˆ¶å€)
            // å¯¬åº¦çµ±ä¸€ç‚º w-1/3
            controlsDiv.innerHTML = `<button id="newGameBtn" class="control-btn w-1/3">${getButtonHtml('NEW_BTN', 'å†ä¾†ä¸€å±€ (New Game)')}</button>`;
            document.getElementById('newGameBtn').onclick = startGame;
        }


        // --- 5. Canvas ç¹ªåœ–èˆ‡ RWD (ä¸è®Š) ---

        // å¡ç‰‡å¤§å° (ç›¸å°æ–¼ Canvas å¯¬åº¦) 
        const CARD_WIDTH_RATIO = 0.20; 
        const CARD_HEIGHT_RATIO = 0.33; 

        function resizeCanvas() {
            const container = canvas.parentElement;
            // è¨­ç½® canvas çš„å…§éƒ¨è§£æåº¦ï¼Œä½¿å…¶èˆ‡é¡¯ç¤ºå°ºå¯¸åŒ¹é…ï¼Œé¿å…æ¨¡ç³Š
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawGame();
        }

        /**
         * ç¹ªè£½åœ“è§’çŸ©å½¢ (ç”¨æ–¼å¡ç‰‡èƒŒæ™¯)
         */
        function roundRect(x, y, w, h, radius) {
            const r = radius || 5;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.arcTo(x + w, y, x + w, y + r, r);
            ctx.lineTo(x + w, y + h - r);
            ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
            ctx.lineTo(x + r, y + h);
            ctx.arcTo(x, y + h, x, y + h - r, r);
            ctx.lineTo(x, y + r);
            ctx.arcTo(x, y, x + r, y, r);
            ctx.closePath();
        }

        /**
         * ç¹ªè£½å–®å¼µå¡ç‰‡ (åŒ…å«æ–°çš„å¡èƒŒè¨­è¨ˆ)
         */
        function drawCard(card, x, y, w, h, isHidden) {
            const radius = w * 0.1;
            
            // ç¹ªè£½å¡ç‰‡é‚Šç·£
            roundRect(x, y, w, h, radius);
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 2;
            ctx.stroke();

            if (isHidden) {
                // *** ç¹ªè£½å¡èƒŒ (æ·ºç´…è‰²åº•é…ä¸Šç™½è‰²è±æ ¼æ¢ç´‹) ***
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card-back-red') || '#ff8888';
                ctx.fill();

                ctx.strokeStyle = 'white';
                ctx.lineWidth = w * 0.05;
                
                ctx.save();
                ctx.clip(); // é™åˆ¶ç¹ªåœ–å€åŸŸåœ¨åœ“è§’çŸ©å½¢å…§
                
                const gridSize = w * 0.25; // è±æ ¼å¤§å°
                
                // è®Šæ›åŸé»ä¸¦æ—‹è½‰ 45 åº¦
                ctx.translate(x + w / 2, y + h / 2);
                ctx.rotate(Math.PI / 4); 
                ctx.translate(-(x + w / 2), -(y + h / 2));
                
                // ç¹ªè£½ç·šæ¢ (è¦†è“‹æ•´å€‹å€åŸŸ)
                for (let i = x - w; i < x + 2 * w; i += gridSize) {
                    // å‚ç›´ç·š (æ—‹è½‰å¾Œè®Šæ–œç·š)
                    ctx.beginPath();
                    ctx.moveTo(i, y - w);
                    ctx.lineTo(i, y + h + w);
                    ctx.stroke();

                    // æ°´å¹³ç·š (æ—‹è½‰å¾Œè®Šæ–œç·š)
                    ctx.beginPath();
                    ctx.moveTo(x - w, i);
                    ctx.lineTo(x + h + w, i);
                    ctx.stroke();
                }

                ctx.restore(); // æ¢å¾©å‰ªè£å€å’Œè®Šæ›
                
            } else {
                // ç¹ªè£½å¡ç‰‡æ­£é¢
                ctx.fillStyle = 'white';
                ctx.fill();

                const isRed = (card.suit === 'â™¥' || card.suit === 'â™¦');
                ctx.fillStyle = isRed ? '#dc2626' : '#111827';
                
                // å˜—è©¦ç¹ªè£½è‡ªè¨‚åœ–ç‰‡ (J, Q, K)
                if (images[card.value]) {
                    // ç¹ªè£½åœ–ç‰‡
                    ctx.drawImage(images[card.value], x, y, w, h);
                    
                    // ç¹ªè£½å·¦ä¸Šè§’å°å­—å’ŒèŠ±è‰²
                    ctx.font = `${w * 0.18}px 'Noto Sans TC', sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(card.value, x + w * 0.05, y + h * 0.15);
                    ctx.fillText(card.suit, x + w * 0.05, y + h * 0.30);
                    
                } else {
                    // *** ç¹ªè£½æ™®é€šå¡ç‰‡ (å·¦ä¸Šè§’èŠ±è‰²ï¼Œä¸­é–“æ•¸å­—) ***
                    
                    // å·¦ä¸Šè§’èŠ±è‰²
                    ctx.font = `${w * 0.25}px 'Noto Sans TC', sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(card.suit, x + w * 0.08, y + h * 0.20); 

                    // ä¸­é–“æ•¸å­—
                    ctx.font = `${w * 0.6}px 'Noto Sans TC', sans-serif`; // å­—é«”åŠ å¤§
                    ctx.textAlign = 'center';
                    // æ ¹æ“šå­—é«”å¤§å°èª¿æ•´å‚ç›´ä½ç½®
                    ctx.fillText(card.value, x + w / 2, y + h / 2 + (w * 0.6) / 3 * 0.8);
                    
                    // å³ä¸‹è§’èŠ±è‰²
                    ctx.textAlign = 'right';
                    ctx.font = `${w * 0.25}px 'Noto Sans TC', sans-serif`;
                    ctx.fillText(card.suit, x + w * 0.92, y + h * 0.85); 
                }
            }
        }
        
        /**
         * ä¸»ç¹ªåœ–å‡½æ•¸
         * @param {string} finalMessage - éŠæˆ²çµæŸæ™‚é¡¯ç¤ºçš„è¨Šæ¯
         */
        function drawGame(finalMessage = null) {
            const cw = canvas.width;
            const ch = canvas.height;
            const cardW = cw * CARD_WIDTH_RATIO;
            const cardH = ch * CARD_HEIGHT_RATIO;
            const padding = cw * 0.02;

            // 1. æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, cw, ch);
            
            // 2. ç¹ªè£½æ¨™é¡Œ/åˆ†æ•¸å€ (èª¿æ•´ä½ç½®ä»¥é¨°å‡ºå¡ç‰Œç©ºé–“)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = `${cw * 0.045}px 'Noto Sans TC', sans-serif`;
            ctx.textAlign = 'center';
            
            // èŠå®¶å€ (Dealer) - å‘ä¸Šç§»å‹•
            const dealerScore = calculateScore(dealerHand, gameStatus !== 'end');
            const dealerScoreText = gameStatus !== 'end' ? '??' : dealerScore;
            ctx.fillText(`èŠå®¶ (Dealer): ${dealerScoreText} é»`, cw / 2, ch * 0.08); 
            
            // ç©å®¶å€ (Player) - å‘ä¸‹ç§»å‹•
            const playerScore = calculateScore(playerHand, false);
            ctx.fillText(`ç©å®¶ (Player): ${playerScore} é»`, cw / 2, ch * 0.95); // ç§»åˆ°æ›´åº•éƒ¨

            // 3. ç¹ªè£½èŠå®¶çš„ç‰Œ
            // èª¿æ•´èµ·å§‹ X åº§æ¨™ï¼Œä½¿ç‰Œçµ„å±…ä¸­
            const dealerStart_x = cw / 2 - ((dealerHand.length * cardW) + (dealerHand.length - 1) * padding) / 2;
            dealerHand.forEach((card, i) => {
                const isHidden = (i === 0 && gameStatus !== 'end');
                drawCard(
                    card, 
                    dealerStart_x + i * (cardW + padding), 
                    ch * 0.13, // ç¨å¾®å‘ä¸Šç§»å‹•
                    cardW, 
                    cardH, 
                    isHidden
                );
            });

            // 4. ç¹ªè£½ç©å®¶çš„ç‰Œ
            // èª¿æ•´èµ·å§‹ X åº§æ¨™ï¼Œä½¿ç‰Œçµ„å±…ä¸­
            const playerStart_x = cw / 2 - ((playerHand.length * cardW) + (playerHand.length - 1) * padding) / 2;
            playerHand.forEach((card, i) => {
                drawCard(
                    card, 
                    playerStart_x + i * (cardW + padding), 
                    ch * 0.54, // å‘ä¸Šç§»å‹•ï¼Œç‚ºæ›´å¤§çš„å¡ç‰‡å’Œåº•éƒ¨åˆ†æ•¸é¨°å‡ºç©ºé–“
                    cardW, 
                    cardH, 
                    false
                );
            });

            // 5. ç¹ªè£½éŠæˆ²ç‹€æ…‹è¨Šæ¯
            if (finalMessage) {
                // ç°è‰²èƒŒæ™¯ (é«˜åº¦ç¸®å°ï¼Œé˜²æ­¢èˆ‡å¡ç‰‡éåº¦é‡ç–Š)
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                // èª¿æ•´é»‘æ¡†ä½ç½®ï¼šå¾ ch * 0.38 é–‹å§‹ï¼Œé«˜åº¦ç‚º ch * 0.24
                roundRect(cw * 0.1, ch * 0.38, cw * 0.8, ch * 0.24, 10); 
                ctx.fill();

                // è¨Šæ¯æ–‡å­— (å‚ç›´å±…ä¸­åœ¨é»‘æ¡†å…§)
                ctx.fillStyle = '#FFF';
                ctx.font = `${cw * 0.05}px 'Noto Sans TC', sans-serif`;
                ctx.textAlign = 'center';
                // å‚ç›´ä½ç½® = æ¡†èµ·å§‹ä½ç½® + æ¡†é«˜åº¦/2 (å³ ch * 0.38 + ch * 0.12)
                ctx.fillText(finalMessage, cw / 2, ch * 0.50); 
                
                // å‹•æ…‹é¡¯ç¤ºã€Œå†ä¾†ä¸€å±€ã€åœ–ç‰‡æŒ‰éˆ• (å–ä»£æ§åˆ¶å€)
                // å¯¬åº¦çµ±ä¸€ç‚º w-1/3
                controlsDiv.innerHTML = `<button id="newGameBtn" class="control-btn w-1/3">${getButtonHtml('NEW_BTN', 'å†ä¾†ä¸€å±€ (New Game)')}</button>`;
                document.getElementById('newGameBtn').onclick = startGame;

            } else if (gameStatus === 'initial') {
                // åˆå§‹/ç­‰å¾…ç‹€æ…‹ï¼šç¹ªè£½æ­¡è¿åœ–ç‰‡
                if (images['WELCOME']) {
                    ctx.drawImage(images['WELCOME'], 0, 0, cw, ch);
                } else {
                    // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œå‰‡å›é€€åˆ°æ–‡å­—é¡¯ç¤º
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    roundRect(cw * 0.1, ch * 0.35, cw * 0.8, ch * 0.3, 10);
                    ctx.fill();

                    ctx.fillStyle = 'white';
                    ctx.font = `${cw * 0.06}px 'Noto Sans TC', sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.fillText('æº–å‚™é–‹å§‹éŠæˆ²', cw / 2, ch * 0.45);
                    ctx.font = `${cw * 0.04}px 'Noto Sans TC', sans-serif`;
                    ctx.fillText('é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œç™¼ç‰Œ', cw / 2, ch * 0.55);
                }

                // åˆå§‹ç‹€æ…‹ä¸‹ï¼Œæ§åˆ¶æŒ‰éˆ•æ‡‰è©²åªæœ‰ Start/New Game - ä½¿ç”¨åœ–ç‰‡æŒ‰éˆ•
                // å¯¬åº¦çµ±ä¸€ç‚º w-1/3
                 controlsDiv.innerHTML = `<button id="newGameBtn" class="control-btn w-1/3">${getButtonHtml('NEW_BTN', 'é–‹å§‹éŠæˆ² (Start Game)')}</button>`;
                document.getElementById('newGameBtn').onclick = startGame;
            } else if (gameStatus === 'playerTurn') {
                 // ç¢ºä¿æ§åˆ¶æŒ‰éˆ•ç‚º Hit/Stand - ä½¿ç”¨åœ–ç‰‡æŒ‰éˆ•
                 if (!document.getElementById('hitBtn') || !document.getElementById('standBtn')) {
                    controlsDiv.innerHTML = `
                        <button id="hitBtn" class="control-btn w-1/3">${getButtonHtml('HIT_BTN', 'è¦ç‰Œ (Hit)')}</button>
                        <button id="standBtn" class="control-btn w-1/3">${getButtonHtml('STAND_BTN', 'åœç‰Œ (Stand)')}</button>
                    `;
                    document.getElementById('hitBtn').onclick = hit;
                    document.getElementById('standBtn').onclick = stand;
                 }
            }
        }


        // --- 6. äº‹ä»¶ç›£è½å™¨ ---
        
        // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        window.onload = function() {
            loadImages();
            // åœ¨ Canvas å®¹å™¨ä¸Šç›£è½é»æ“Šäº‹ä»¶ï¼Œå¦‚æœéŠæˆ²çµæŸï¼Œé»æ“Šç•«å¸ƒä¸­å¤®çš„æŒ‰éˆ•
            canvas.addEventListener('click', (event) => {
                if (gameStatus === 'end' || gameStatus === 'initial') {
                    // æ¨¡æ“¬é»æ“Šä¸­å¤®çš„ New Game æŒ‰éˆ•
                    const newGameBtn = document.getElementById('newGameBtn');
                    if (newGameBtn) {
                        newGameBtn.click();
                    }
                }
            });
        };

        // RWD è™•ç†ï¼šè¦–çª—å¤§å°æ”¹è®Šæ™‚é‡è¨­ Canvas å°ºå¯¸
        window.addEventListener('resize', resizeCanvas);

        // åˆå§‹è¨­å®šæ§åˆ¶æŒ‰éˆ•äº‹ä»¶ (é€™äº›æœƒåœ¨ loadImages çµæŸå¾Œè¢«è¦†è“‹ï¼Œä½†ç‚ºäº†é˜²æ­¢åˆæœŸéŒ¯èª¤è€Œä¿ç•™)
        document.getElementById('hitBtn').onclick = hit;
        document.getElementById('standBtn').onclick = stand;
        document.getElementById('resetStatsBtn').onclick = resetStats;
    </script>
</body>
</html>

